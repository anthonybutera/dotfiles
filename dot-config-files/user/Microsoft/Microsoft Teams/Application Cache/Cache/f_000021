webpackJsonp([8],{2321:function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),t(2322)},2322:function(e,n,t){"use strict";var o=this&&this.__extends||function(){var e=function(n,t){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,n){e.__proto__=n}||function(e,n){for(var t in n)n.hasOwnProperty(t)&&(e[t]=n[t])})(n,t)};return function(n,t){function o(){this.constructor=n}e(n,t),n.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)}}();Object.defineProperty(n,"__esModule",{value:!0});var i=t(2323),r=t(2345),s=t(2346),a=t(2347),c=function(e){function n(n,t,o){var i=e.call(this,o)||this;return i.transportDependencyProviderService=n,i.logger=n.loggingService.newLogger("transportLazyLoadService"),i.initializeOnAppLaunchAndReinit(),i}return o(n,e),n.$inject=["transportDependencyProviderService","transportAgentService","orchestrationService"],n.prototype.getTransportCommandRouter=function(){return this.transportCommandRouter},n.prototype.getTransportConnectionHandler=function(){return this.transportConnectionHandler},n.prototype.getTransportAgentHandler=function(){return this.transportAgentHandler},n.prototype.getTransportCallKeeper=function(){return this.transportCallKeeper},n.prototype.initializeTranportConnectionHandling=function(e,n){this.transportCommandRouter=new i.TransportCommandRouter(this.transportDependencyProviderService,n,e),this.transportConnectionHandler=new r.TransportConnectionHandler(this.transportDependencyProviderService,this.transportCommandRouter),this.transportAgentHandler=new s.TransportAgentHandler(this.transportCommandRouter,this.transportConnectionHandler),this.transportCallKeeper=new a.TransportCallKeeper(this.transportDependencyProviderService)},n.prototype.cleanupOnAppTeardown=function(e){this.logger.info("clean up has been called. marking commandRouter and connectionHandler as undefined."),this.transportConnectionHandler.cleanUpConnectionHandler(),this.transportCallKeeper.cleanupCallKeeper(),this.transportCommandRouter=void 0,this.transportConnectionHandler=void 0,this.transportAgentHandler=void 0,this.transportCallKeeper=void 0},n.prototype.initializeOnAppLaunchAndReinit=function(e){},n.prototype.mtmaTelemetryIdentifier=function(){return"TransportLazyLoadService"},n}(teamspace.services.MTMABase);n.TransportLazyLoadService=c,angular.module("teamspace.transportLazyLoadService",["teamspace.transportDependencyProviderService","teamspace.transportAgentService"]).service("transportLazyLoadService",c)},2323:function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var o,i=t(2324),r=t(2337);!function(e){e.InitState="InitState",e.ActiveIncomingCommandsCount="ActiveIncomingCommandsCount",e.ActiveOutgoingCommandsCount="ActiveOutgoingCommandsCount",e.AckFailedCountInSession="AckFailedCountInSession",e.AckSuccessCountInSession="AckSuccessCountInSession"}(o=n.TransportCommandRouterStates||(n.TransportCommandRouterStates={}));var s=function(){function e(e,n,t){this.transportDependencyProviderService=e,this.transportStack=n,this.transportUser=t,this.ComponentName="TransportCommandRouter",this.ackSuccessCount=0,this.ackFailureCount=0,this.outgoingCommandResponseTimeout=6e4,this.incomingCommandFactory=new i.IncomingCommandFactory(e),this.outgoingCommandFactory=new r.OutgoingCommandFactory(e),this.activeIncomingCommands=new Map,this.activeOutgoingCommands=new Map,this.setupInitialStates(),this.constants=e.constants,this.logger=e.loggingService.newLogger(this.ComponentName),this.states.set(o.InitState,teamspace.services.ITransportComponentState.Initialized)}return e.prototype.onIncomingCommandReceived=function(e,n){var t,o=this;if(e&&e.command){var i=this.getScenarioNameForIncomingCommand(e.command);t=this.transportDependencyProviderService.loggingService.newScenario(i,null,null,null,!0)}else t=this.transportDependencyProviderService.loggingService.newScenario(this.constants.scenarios.betterTogether.incomingCommand.invalidCommand,null,null,null,!0);if(this.validateIncomingCommand(e,n,t)){var r=e.command;if(this.logger.info("Incoming command received with name - "+r),r!==teamspace.services.IncomingCommand.Response){var s=this.incomingCommandFactory.createCommand(e,t);if(!s){var a="Incoming Command not created for "+e.command+". Command not compatible or implemented";return this.logger.error(a),void this.ackIncomingCommandFailure(n,a)}this.activeIncomingCommands.set(e.causeId,s),this.ackIncomingCommandSuccess(n),s.action().promise.then(function(n){o.sendResponse(e,n),o.logger.info("Sending response for "+e.command)}).catch(function(n){o.sendResponse(e,n,!0),o.logger.error("Error in executing command "+e.command+" - Error - "+n.errorDetails)})}else{this.ackIncomingCommandSuccess(n);var c=JSON.parse(e.commandDetails);this.onResponseReceivedForOutgoingCommand(c,t)}}},e.prototype.ackIncomingCommandSuccess=function(e){var n=e({status:200,body:JSON.stringify({})}),t=this.transportDependencyProviderService.loggingService.newScenario(this.constants.scenarios.betterTogether.commandRouter.ackIncomingCommand,null,null,null,!0);if(0!==n){var o="Failed to send ack for the incoming command - result: "+n;t.fail({message:o}),this.logger.error(o)}else{var i="Ack sent for incoming command";t.stop({message:i}),this.logger.info(i)}},e.prototype.ackIncomingCommandFailure=function(e,n){var t=e({status:404,body:n?JSON.stringify(n):JSON.stringify({})}),o=this.transportDependencyProviderService.loggingService.newScenario(this.constants.scenarios.betterTogether.commandRouter.ackIncomingCommand,null,null,null,!0);if(0!==t){var i="Failed to send failure for the incoming command - result: "+t;o.fail({message:i}),this.logger.error(i)}else{var r="Failed-Ack-response sent for incoming command";o.stop({message:r}),this.logger.info(r)}},e.prototype.validateIncomingCommand=function(e,n,t){if(!this.transportDependencyProviderService.canInitializeTransport()){r="ECS not enabled. Received incoming command "+e.command;return this.logger.error(r),t.stop({message:r}),!1}if(!e){r="Invalid transport command";return this.logger.error(r),t.fail({message:r}),!1}var o=this.transportDependencyProviderService.callingAgentsService,i=JSON.parse(e.commandDetails);if(i.targetEndpointId&&o.getRegistrationId()!==i.targetEndpointId){var r="Incoming commmand is not meant for this endpoint id";return this.logger.error(r),t.fail({message:r}),this.ackIncomingCommandFailure(n,r),!1}return!0},e.prototype.cleanupIncomingCommand=function(e){var n=this.activeIncomingCommands.get(e);n&&(this.activeIncomingCommands.delete(e),n=void 0)},e.prototype.sendResponse=function(e,n,t){var o=this;void 0===t&&(t=!1);var i=t?400:200,r=e.causeId;if(this.activeIncomingCommands.get(r)){if(n){n.statusCode=i,n.requestCauseId=r;var s=this.sendOutgoingCommand(teamspace.services.OutgoingCommand.Response,n,e.endpointId);s?s.promise.then(function(e){o.logger.info("Response completed")}):this.logger.error("Response command not created")}this.cleanupIncomingCommand(r)}},e.prototype.sendOutgoingCommand=function(e,n,t){var o=this,i=this.getScenarioNameForOutgoingCommand(e),r=this.transportDependencyProviderService.loggingService.newScenario(i,null,null,null,!0);if(!this.transportDependencyProviderService.canInitializeTransport()){c="FF not enabled for outgoing command "+e;return r.fail({message:c}),this.logger.error(c),(d=this.transportDependencyProviderService.$q.defer()).reject(c),d}var s;if(t?s=this.getIBTTransportEndpoint(t,!0):(s=this.getIBTTransportEndpoint(t,!1))&&this.isSessionEstablishedWithEndpoint(s)||(s=this.getIBTTransportEndpoint(t,!0)),!s){c="Outgoing Command not created for "+e+". No available endpoint to send the command to";return r.fail({message:c}),this.logger.error(c),(d=this.transportDependencyProviderService.$q.defer()).reject(c),d}n.targetEndpointId=s.getEndpointId();var a=this.outgoingCommandFactory.createCommand(e,n,s,r);if(!a){var c="Command not created for "+e+". Not compatible or implemented";this.logger.error(c);var d=this.transportDependencyProviderService.$q.defer();return d.reject(c),d}return this.activeOutgoingCommands.set(a.causeId,a),this.logger.info("Command added to the active outgoing commands. "+a.causeId+". Name - "+a.name+" Size is - "+this.activeOutgoingCommands.size),a.onCommandReadyToSend.promise.then(function(t){var i=o.createBTTOutgoingCommandListener(r);a.commandResponseListener=i;var s=n?JSON.stringify(n):"";if(o.isSessionEstablishedWithEndpoint(a.endpoint)){c="outgoing command sent for command name - "+e;o.logger.info(c),a.endpoint.sendCommand(a.causeId,e,s,i)}else{var c="Sending command for session setup, command name - "+e;o.logger.info(c),a.endpoint.setupSession(a.causeId,e,s,i)}setTimeout(function(){if(-1!==o.cleanupOutgoingCommand(a.causeId)){var n="no response received for outgoing command with name - "+e+" within threshold time.",t={errorDetails:n,statusCode:400,salt:[-1],requestCauseId:a.causeId};a.onResponseReceived.reject(t),o.logger.error(n)}},o.outgoingCommandResponseTimeout)}).catch(function(e){var n={errorDetails:e,statusCode:400,salt:[-1],requestCauseId:a.causeId};a.onResponseReceived.reject(n),o.cleanupOutgoingCommand(a.causeId)}),a.onResponseReceived},e.prototype.isSessionEstablishedWithEndpoint=function(e){var n=this.transportDependencyProviderService.getPairedAndActiveEndpoint();return!(!n||!e)&&n.endPointId===e.getEndpointId()},e.prototype.startSession=function(e){this.logger.info("starting session with endpoint with a force discover.");var n=this.getIBTTransportEndpoint(e,!0);n&&n.setSessionEstablished(!0)},e.prototype.endSession=function(e){this.logger.info("ending session with endpoint without a force discover.");var n=this.getIBTTransportEndpoint(e,!1);n&&(n.setSessionEstablished(!1),this.ackFailureCount=0,this.ackSuccessCount=0)},e.prototype.getStates=function(){return this.states.set(o.ActiveOutgoingCommandsCount,this.activeOutgoingCommands.size),this.states.set(o.ActiveIncomingCommandsCount,this.activeIncomingCommands.size),this.states.set(o.AckFailedCountInSession,this.ackFailureCount),this.states.set(o.AckSuccessCountInSession,this.ackSuccessCount),this.states},e.prototype.setupInitialStates=function(){this.states=new Map,this.states.set(o.InitState,teamspace.services.ITransportComponentState.Uninitialized)},e.prototype.onResponseReceivedForOutgoingCommand=function(e,n){var t={message:"",result:!1};if(!e.requestCauseId){i="Request cause id not found with the response";return this.logger.error(i),void n.fail({message:i})}var o=this.activeOutgoingCommands.get(e.requestCauseId);if(!o){i="No outgoing command found with the requestCauseId or response not required";return this.logger.error(i),void n.fail({message:i})}if(n.stop(),200!==e.statusCode){var i="response is not OK for command name - "+o.name+", status code- "+e.statusCode+" and error details - "+e.errorDetails;t.message=i,this.logger.error(i),o.onResponseReceived.reject(e)}else{var r="response resolved for outgoing command name - "+o.name;t.message=r,this.logger.info(r),o.onResponseReceived.resolve(e)}this.cleanupOutgoingCommand(e.requestCauseId)},e.prototype.cleanupOutgoingCommand=function(e){var n=this.activeOutgoingCommands.get(e);if(n){n.commandResponseListener&&n.commandResponseListener.dispose(),this.logger.info("Command with causeid - "+e+" cleaned up. Name - "+n.name+" Size is - "+this.activeOutgoingCommands.size);var t=n.startTime;if(this.activeOutgoingCommands.delete(e),n=void 0,t)return(new Date).getTime()-t.getTime()}return-1},e.prototype.createBTTOutgoingCommandListener=function(e){var n=this,t=this.transportStack.createOutgoingCommandResponse();return t.on("request-succeeded",function(t){var o=t.causeId,i=t.responseBody;n.ackSuccessCount++,n.logger.info("Received transport response for "+o+".");var r=n.activeOutgoingCommands.get(o);if(r){var s=i?JSON.parse(i):void 0;if(r.commandDetails.companionResponseRequired){c="Command acknowledged by companion device,command name - "+r.name+", requires response from device";n.logger.info(c),e.appendEventData({message1:c})}else{r.onResponseReceived.resolve(s);var a=n.cleanupOutgoingCommand(o),c="Outgoing command does not need response,command name - "+r.name+" time taken is "+a;n.logger.info(c),e.appendEventData({message1:c})}}else{var d=t.causeId?t.causeId:"causeID not present";n.logger.error("No valid outgoing command in request-succeeded. causeId - "+d),e.fail({message:"No valid outgoing command in request-succeeded. causeId - "+d})}}),t.on("request-failed",function(t){var o=t.causeId,i=t.errorCode,r=t.responseBody;n.ackFailureCount++,n.logger.info("Received transport response. errorCode - "+i);var s=n.activeOutgoingCommands.get(o);if(s){if(!s.isRetry){var a=s.startTime,c=0;a&&(c=(new Date).getTime()-a.getTime());var d="received error response for outgoing command name - "+s.name+", causeId "+o+", errorCode - "+i+", time taken is "+c;n.logger.error(d),e.appendEventData({message1:d});var m=JSON.stringify(s.commandDetails);s.isRetry=!0;var p=s.endpoint.getEndpointId(),l=n.getIBTTransportEndpoint(p,!0);s.endpoint=l;var v=n.transportDependencyProviderService.utilityService.generateUUID();return s.causeId=v,n.activeOutgoingCommands.delete(o),n.activeOutgoingCommands.set(v,s),n.logger.error("First attempt for command failed. Retry-ing command "+s.name+", causeId "+o+" with new causeid "+v),void l.sendCommand(s.causeId,s.name,m,s.commandResponseListener)}var g=r?JSON.parse(r):{};g.statusCode=i,g.errorDetails||(g.errorDetails="errorCode is "+i),s.onResponseReceived.reject(g);var u=n.cleanupOutgoingCommand(o),h="Failed on second attempt. received error response for outgoing command name - "+s.name+", causeId "+o+", errorCode - "+i+", time taken is "+u;n.logger.error(h),e.fail({message:h})}else{var f=t.causeId?t.causeId:"causeID not present";n.logger.error("No valid outgoing command in request-succeeded. causeId - "+f),e.fail({message:"No valid outgoing command in request-succeeded. causeId - "+f})}}),t},e.prototype.getIBTTransportEndpoint=function(e,n){if(void 0===n&&(n=!1),!e){this.logger.info("endpoint id is not given, trying to get it from pairedAndActive Endpoint");var t=this.transportDependencyProviderService.getPairedAndActiveEndpoint();if(!t)return this.logger.error("There is no active paired device to send the command."),null;e=t.endPointId}this.logger.info("trying to get endpoint from transport user for endpointid - "+e);var o;return n?(o=this.transportUser.discover().find(function(n){return n.getEndpointId()===e}),this.logger.info("endpoints retrieved using discover(). "+!!o)):(o=this.transportUser.getEndpoints().find(function(n){return n.getEndpointId()===e}),this.logger.info("endpoints retrieved using getEndpoints(). "+!!o)),o},e.prototype.getScenarioNameForIncomingCommand=function(e){switch(e){case teamspace.services.IncomingCommand.Response:return this.transportDependencyProviderService.constants.scenarios.betterTogether.incomingCommand.response;case teamspace.services.IncomingCommand.Broadcast:return this.transportDependencyProviderService.constants.scenarios.betterTogether.incomingCommand.broadcast;case teamspace.services.IncomingCommand.Pair:return this.transportDependencyProviderService.constants.scenarios.betterTogether.incomingCommand.pair;case teamspace.services.IncomingCommand.Unpair:return this.transportDependencyProviderService.constants.scenarios.betterTogether.incomingCommand.unpair;case teamspace.services.IncomingCommand.Autopair:return this.transportDependencyProviderService.constants.scenarios.betterTogether.incomingCommand.autoPair;case teamspace.services.IncomingCommand.Locked:return this.transportDependencyProviderService.constants.scenarios.betterTogether.incomingCommand.incomingLock;case teamspace.services.IncomingCommand.Unlocked:return this.transportDependencyProviderService.constants.scenarios.betterTogether.incomingCommand.incomingUnlock;case teamspace.services.IncomingCommand.ReplyOnDesktop:return this.transportDependencyProviderService.constants.scenarios.betterTogether.incomingCommand.replyFromDesktop;case teamspace.services.IncomingCommand.OpenFileOnDesktop:return this.transportDependencyProviderService.constants.scenarios.betterTogether.incomingCommand.openFile;case teamspace.services.IncomingCommand.UpdateEndpoint:return this.transportDependencyProviderService.constants.scenarios.betterTogether.incomingCommand.updateEndpoint;case teamspace.services.IncomingCommand.OpenShare:return this.transportDependencyProviderService.constants.scenarios.betterTogether.incomingCommand.openShare;case teamspace.services.IncomingCommand.StartCall:return this.transportDependencyProviderService.constants.scenarios.betterTogether.incomingCommand.startcall;case teamspace.services.IncomingCommand.EndCall:return this.transportDependencyProviderService.constants.scenarios.betterTogether.incomingCommand.endcall;case teamspace.services.IncomingCommand.Mute:return this.transportDependencyProviderService.constants.scenarios.betterTogether.incomingCommand.mute;case teamspace.services.IncomingCommand.Unmute:return this.transportDependencyProviderService.constants.scenarios.betterTogether.incomingCommand.unmute;case teamspace.services.IncomingCommand.StartVideo:return this.transportDependencyProviderService.constants.scenarios.betterTogether.incomingCommand.startvideo;case teamspace.services.IncomingCommand.StopVideo:return this.transportDependencyProviderService.constants.scenarios.betterTogether.incomingCommand.stopvideo;case teamspace.services.IncomingCommand.StartAudio:return this.transportDependencyProviderService.constants.scenarios.betterTogether.incomingCommand.startaudio;case teamspace.services.IncomingCommand.StopAudio:return this.transportDependencyProviderService.constants.scenarios.betterTogether.incomingCommand.stopaudio;case teamspace.services.IncomingCommand.HoldCall:return this.transportDependencyProviderService.constants.scenarios.betterTogether.incomingCommand.holdcall;case teamspace.services.IncomingCommand.UnholdCall:return this.transportDependencyProviderService.constants.scenarios.betterTogether.incomingCommand.unholdcall;case teamspace.services.IncomingCommand.ReportProblem:return this.transportDependencyProviderService.constants.scenarios.betterTogether.incomingCommand.reportProblem;default:return this.transportDependencyProviderService.constants.scenarios.betterTogether.incomingCommand.invalidCommand}},e.prototype.getScenarioNameForOutgoingCommand=function(e){switch(e){case teamspace.services.OutgoingCommand.Response:return this.transportDependencyProviderService.constants.scenarios.betterTogether.outgoingCommand.response;case teamspace.services.OutgoingCommand.KeepAlive:return this.transportDependencyProviderService.constants.scenarios.betterTogether.outgoingCommand.keepAlive;case teamspace.services.OutgoingCommand.Unpair:return this.transportDependencyProviderService.constants.scenarios.betterTogether.outgoingCommand.unpair;case teamspace.services.OutgoingCommand.Lock:return this.transportDependencyProviderService.constants.scenarios.betterTogether.outgoingCommand.outgoingLock;case teamspace.services.OutgoingCommand.Unlock:return this.transportDependencyProviderService.constants.scenarios.betterTogether.outgoingCommand.outgoingUnlock;case teamspace.services.OutgoingCommand.StartCall:return this.transportDependencyProviderService.constants.scenarios.betterTogether.outgoingCommand.startcall;case teamspace.services.OutgoingCommand.EndCall:return this.transportDependencyProviderService.constants.scenarios.betterTogether.outgoingCommand.endcall;case teamspace.services.OutgoingCommand.Mute:return this.transportDependencyProviderService.constants.scenarios.betterTogether.outgoingCommand.mute;case teamspace.services.OutgoingCommand.Unmute:return this.transportDependencyProviderService.constants.scenarios.betterTogether.outgoingCommand.unmute;case teamspace.services.OutgoingCommand.StartVideo:return this.transportDependencyProviderService.constants.scenarios.betterTogether.outgoingCommand.startvideo;case teamspace.services.OutgoingCommand.StopVideo:return this.transportDependencyProviderService.constants.scenarios.betterTogether.outgoingCommand.stopvideo;case teamspace.services.OutgoingCommand.StartAudio:return this.transportDependencyProviderService.constants.scenarios.betterTogether.outgoingCommand.startaudio;case teamspace.services.OutgoingCommand.StopAudio:return this.transportDependencyProviderService.constants.scenarios.betterTogether.outgoingCommand.stopaudio;case teamspace.services.OutgoingCommand.StartVideo:return this.transportDependencyProviderService.constants.scenarios.betterTogether.outgoingCommand.startvideo;case teamspace.services.OutgoingCommand.StopVideo:return this.transportDependencyProviderService.constants.scenarios.betterTogether.outgoingCommand.stopvideo;case teamspace.services.OutgoingCommand.StartAudio:return this.transportDependencyProviderService.constants.scenarios.betterTogether.outgoingCommand.startaudio;case teamspace.services.OutgoingCommand.StopAudio:return this.transportDependencyProviderService.constants.scenarios.betterTogether.outgoingCommand.stopaudio;case teamspace.services.OutgoingCommand.HoldCall:return this.transportDependencyProviderService.constants.scenarios.betterTogether.outgoingCommand.holdcall;case teamspace.services.OutgoingCommand.UnholdCall:return this.transportDependencyProviderService.constants.scenarios.betterTogether.outgoingCommand.unholdcall;case teamspace.services.OutgoingCommand.ReportProblem:return this.transportDependencyProviderService.constants.scenarios.betterTogether.outgoingCommand.reportProblem;default:return this.transportDependencyProviderService.constants.scenarios.betterTogether.outgoingCommand.invalidCommand}},e}();n.TransportCommandRouter=s},2324:function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var o=t(2325),i=t(2326),r=t(2327),s=t(2328),a=t(2329),c=t(2330),d=t(2331),m=t(2332),p=t(2333),l=t(2334),v=t(2335),g=t(2336),u=function(){function e(e){this.transportDependencyProviderService=e,this.logger=e.loggingService.newLogger("IncomingCommandFactory")}return e.prototype.createCommand=function(e,n){var t=e.command.toLowerCase(),u=JSON.parse(e.commandDetails),h=e.endpointId;if(!this.shouldCreateCommand(t,u,n))return null;switch(t){case teamspace.services.IncomingCommand.Broadcast:return new o.BroadcastCommand(u,this.transportDependencyProviderService,n);case teamspace.services.IncomingCommand.Pair:return new i.PairCommand(u,h,this.transportDependencyProviderService,n);case teamspace.services.IncomingCommand.Unpair:return new r.UnpairCommand(u,h,this.transportDependencyProviderService,n);case teamspace.services.IncomingCommand.Autopair:return new s.AutopairCommand(u,h,this.transportDependencyProviderService,n);case teamspace.services.IncomingCommand.Locked:return new a.LockedCommand(u,h,this.transportDependencyProviderService,n);case teamspace.services.IncomingCommand.Unlocked:return new c.UnlockedCommand(u,h,this.transportDependencyProviderService,n);case teamspace.services.IncomingCommand.ReplyOnDesktop:return new d.ReplyFromDesktopCommand(u,this.transportDependencyProviderService,n);case teamspace.services.IncomingCommand.OpenFileOnDesktop:return new m.OpenFileCommand(u,this.transportDependencyProviderService,n);case teamspace.services.IncomingCommand.UpdateEndpoint:return new p.UpdateEndpointCommand(u,h,this.transportDependencyProviderService,n);case teamspace.services.IncomingCommand.OpenShare:return new l.OpenShareCommand(u,this.transportDependencyProviderService,n);case teamspace.services.IncomingCommand.StartCall:return new v.StartCallCommand(u,this.transportDependencyProviderService,n);case teamspace.services.IncomingCommand.EndCall:return new v.EndCallCommand(u,this.transportDependencyProviderService,n);case teamspace.services.IncomingCommand.StartAudio:case teamspace.services.IncomingCommand.StopAudio:case teamspace.services.IncomingCommand.Mute:case teamspace.services.IncomingCommand.Unmute:case teamspace.services.IncomingCommand.StartVideo:case teamspace.services.IncomingCommand.StopVideo:case teamspace.services.IncomingCommand.HoldCall:case teamspace.services.IncomingCommand.UnholdCall:return new v.BaseCallToggleStateCommand(u,this.transportDependencyProviderService,t,n);case teamspace.services.IncomingCommand.ReportProblem:return new g.ReportProblemIncomingCommand(u,this.transportDependencyProviderService,n);default:return n.fail({message:"Incoming Command not created for "+e.command+". Command not compatible or implemented"}),null}},e.prototype.shouldCreateCommand=function(e,n,t){var o=this.transportDependencyProviderService.getTransportConnectionHandler();if(!(e===teamspace.services.IncomingCommand.Broadcast||e===teamspace.services.IncomingCommand.Unpair||e===teamspace.services.IncomingCommand.ReportProblem||o.verifySalt(n))){r="Salt is not valid";return this.logger.error(r),t.stop({message:r}),!1}var i=o.getConnectedDevice();if(e===teamspace.services.IncomingCommand.Broadcast||e===teamspace.services.IncomingCommand.Autopair||e===teamspace.services.IncomingCommand.Pair||e===teamspace.services.IncomingCommand.Unpair||e===teamspace.services.IncomingCommand.Locked||e===teamspace.services.IncomingCommand.Unlocked||e===teamspace.services.IncomingCommand.UpdateEndpoint||e===teamspace.services.IncomingCommand.ReportProblem||i){if(!this.meetingsNotAllowed(e))return!0;r="Cannot execute meetings/calling related command with name - "+e+" if device is not selected from device settings.";this.logger.error(r),t.stop({message:r})}else{var r="Cannot execute command with name - "+e;this.logger.error(r),t.fail({message:r})}return!1},e.prototype.meetingsNotAllowed=function(e){return!(e!==teamspace.services.IncomingCommand.StartCall&&e!==teamspace.services.IncomingCommand.EndCall&&e!==teamspace.services.IncomingCommand.StartAudio&&e!==teamspace.services.IncomingCommand.StopAudio&&e!==teamspace.services.IncomingCommand.Mute&&e!==teamspace.services.IncomingCommand.Unmute&&e!==teamspace.services.IncomingCommand.StartVideo&&e!==teamspace.services.IncomingCommand.StopVideo&&e!==teamspace.services.IncomingCommand.HoldCall&&e!==teamspace.services.IncomingCommand.UnholdCall||this.transportDependencyProviderService.isConnectedToTransportEndpointForMeetings()||this.transportDependencyProviderService.isConnectedToTransportEndpointForCalling())},e}();n.IncomingCommandFactory=u},2325:function(e,n,t){"use strict";var o=this&&this.__assign||function(){return(o=Object.assign||function(e){for(var n,t=1,o=arguments.length;t<o;t++){n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)};Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,n,t){this.commandDetails=e,this.transportDependencyProviderService=n,this.incomingCommandReceivedScenario=t,this.commandDetails=e}return e.prototype.action=function(){var e=this,n=this.transportDependencyProviderService,t=n.$q,i=n.resources,r=n.$translate;this.responseDeferred=t.defer();var s=this.transportDependencyProviderService.getTransportConnectionHandler();return s.checkProximity().promise.then(function(n){if(n){var t=window.desktopEnvironment&&window.desktopEnvironment.hostname?window.desktopEnvironment.hostname:r.instant(i.strings.meeting_unknown_status_text),a=o({deviceName:t},s.getResponseDetails());e.incomingCommandReceivedScenario.stop({message:"device in proximity,resolving response"}),e.responseDeferred.resolve(a)}else{a=o({errorDetails:"Companion device is not in proximity."},s.getResponseDetails());e.incomingCommandReceivedScenario.stop({message:a.errorDetails}),e.responseDeferred.reject(a)}}).catch(function(n){var t=o({errorDetails:n},s.getResponseDetails());e.incomingCommandReceivedScenario.fail({message:t.errorDetails}),e.responseDeferred.reject(t)}),this.responseDeferred},e}();n.BroadcastCommand=i},2326:function(e,n,t){"use strict";var o=this&&this.__assign||function(){return(o=Object.assign||function(e){for(var n,t=1,o=arguments.length;t<o;t++){n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)};Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,n,t,o){this.commandDetails=e,this.endpointId=n,this.transportDependencyProviderService=t,this.incomingCommandReceivedScenario=o}return e.prototype.action=function(){var e=this,n=this.transportDependencyProviderService,t=n.$q,o=n.$translate,i=n.resources,r=n.dialogService;this.responseDeferred=t.defer();var s=!1,a={okButtonText:o.instant(i.strings.better_together_pair_button),closeButtonText:o.instant(i.strings.better_together_cancel_button),confirmMessageTitle:o.instant(i.strings.better_together_pair_title),confirmMessageHtmlBody:o.instant(i.strings.better_together_pair_message,{deviceName:this.commandDetails.deviceName}),callback:function(){s=!0,e.onUserResponse(!0)},preCloseCallback:function(){s||e.onUserResponse(!1)}};return r.open(this.transportDependencyProviderService.constants.dialogs.confirmDialog,a),this.responseDeferred},e.prototype.onUserResponse=function(e,n){var t=this.transportDependencyProviderService.getTransportConnectionHandler(),i=o({accepted:e},t.getResponseDetails());if(e){var r={endPointId:this.endpointId,deviceName:this.commandDetails.deviceName,connectionStatus:teamspace.services.PairedConnectionStatus.Connected,clientType:this.commandDetails.clientType||"",clientVersion:this.commandDetails.clientVersion||""};this.incomingCommandReceivedScenario.stop({message:r.endPointId+", "+r.clientType+", "+r.clientVersion}),t.onNewDevicePaired(r),this.responseDeferred.resolve(i)}else i.accepted=!1,i.errorDetails="Pair rejected by the user",this.incomingCommandReceivedScenario.stop({message:i.errorDetails}),this.responseDeferred.reject(i)},e}();n.PairCommand=i},2327:function(e,n,t){"use strict";var o=this&&this.__assign||function(){return(o=Object.assign||function(e){for(var n,t=1,o=arguments.length;t<o;t++){n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)};Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,n,t,o){this.commandDetails=e,this.endPointId=n,this.transportDependencyProviderService=t,this.incomingCommandReceivedScenario=o}return e.prototype.action=function(){var e=this.transportDependencyProviderService.$q;this.responseDeferred=e.defer();var n=this.transportDependencyProviderService.getTransportConnectionHandler(),t=n.getResponseDetails();return n.onDeviceUnpaired(this.endPointId)?(this.incomingCommandReceivedScenario.stop(),this.responseDeferred.resolve(t)):(t=o({errorDetails:"device is not in the list of paired devices."},t),this.incomingCommandReceivedScenario.fail({message:t.errorDetails}),this.responseDeferred.reject(t)),this.responseDeferred},e}();n.UnpairCommand=i},2328:function(e,n,t){"use strict";var o=this&&this.__assign||function(){return(o=Object.assign||function(e){for(var n,t=1,o=arguments.length;t<o;t++){n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)};Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,n,t,o){this.commandDetails=e,this.endpointId=n,this.transportDependencyProviderService=t,this.incomingCommandReceivedScenario=o,this.commandDetails=e}return e.prototype.action=function(){var e=this,n=this.transportDependencyProviderService.$q;this.responseDeferred=n.defer();var t=this.transportDependencyProviderService.getTransportConnectionHandler();return t.checkProximity().promise.then(function(n){if(n)if(t.reconnect(e.endpointId,!1))e.incomingCommandReceivedScenario.stop({message:"reconnected to Companion device."}),e.responseDeferred.resolve(t.getResponseDetails());else{i=o({errorDetails:"Autopairing not successful from desktop client"},t.getResponseDetails());e.incomingCommandReceivedScenario.fail({message:i.errorDetails}),e.responseDeferred.reject(i)}else{var i=o({errorDetails:"Companion device not in proximity"},t.getResponseDetails());e.incomingCommandReceivedScenario.stop({message:i.errorDetails}),e.responseDeferred.reject(i)}}).catch(function(n){var i=o({errorDetails:n},t.getResponseDetails());e.incomingCommandReceivedScenario.fail({message:i.errorDetails}),e.responseDeferred.reject(i)}),this.responseDeferred},e}();n.AutopairCommand=i},2329:function(e,n,t){"use strict";var o=this&&this.__assign||function(){return(o=Object.assign||function(e){for(var n,t=1,o=arguments.length;t<o;t++){n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)};Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,n,t,o){this.commandDetails=e,this.endPointId=n,this.transportDependencyProviderService=t,this.incomingCommandReceivedScenario=o}return e.prototype.action=function(){var e=this.transportDependencyProviderService.$q;this.responseDeferred=e.defer();var n=this.transportDependencyProviderService.getTransportConnectionHandler(),t=n.getResponseDetails();return n.onDeviceLocked(this.endPointId)?(this.incomingCommandReceivedScenario.stop(),this.responseDeferred.resolve(t)):(t=o({errorDetails:"device not locked, endpoint is not in connected mode"},t),this.incomingCommandReceivedScenario.fail({message:t.errorDetails}),this.responseDeferred.reject(t)),this.responseDeferred},e}();n.LockedCommand=i},2330:function(e,n,t){"use strict";var o=this&&this.__assign||function(){return(o=Object.assign||function(e){for(var n,t=1,o=arguments.length;t<o;t++){n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)};Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,n,t,o){this.commandDetails=e,this.endPointId=n,this.transportDependencyProviderService=t,this.incomingCommandReceivedScenario=o}return e.prototype.action=function(){var e=this.transportDependencyProviderService.$q;this.responseDeferred=e.defer();var n=this.transportDependencyProviderService.getTransportConnectionHandler(),t=n.getResponseDetails();return n.onDeviceUnlocked(this.endPointId)?(this.incomingCommandReceivedScenario.stop(),this.responseDeferred.resolve(t)):(t=o({errorDetails:"device not unlocked, endpoint is not in connected mode"},t),this.incomingCommandReceivedScenario.fail({message:t.errorDetails}),this.responseDeferred.reject(t)),this.responseDeferred},e}();n.UnlockedCommand=i},2331:function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var o=function(){function e(e,n,t){this.commandDetails=e,this.transportDependencyProviderService=n,this.incomingCommandReceivedScenario=t}return e.prototype.action=function(){var e=this,n=this.transportDependencyProviderService,t=n.$q,o=n.callingNavigationService,i=n.channelService,r=n.multiWindowService;this.responseDeferred=t.defer();var s=this.transportDependencyProviderService.getTransportConnectionHandler().getResponseDetails();if(this.commandDetails.conversationId){var a=i.getChannelByObjectId(this.commandDetails.conversationId);r.enabled&&!a?r.openWindow(new teamspace.services.ChatChildWindowParams(this.commandDetails.conversationId),"ReplyFromDesktopCommand").then(function(n){e.incomingCommandReceivedScenario.stop({message:"opened in multi-window,resolving response"}),e.responseDeferred.resolve(s)}).catch(function(n){s.errorDetails=n,e.incomingCommandReceivedScenario.fail({message:"error in opening new window with details - "+n}),e.responseDeferred.reject(s)}):o.navigateToConversation(this.commandDetails.conversationId,this.commandDetails.rootMessageId).then(function(n){e.incomingCommandReceivedScenario.stop({message:"navigated to conversation,resolving response"}),e.responseDeferred.resolve(s)}).catch(function(n){s.errorDetails=n,e.incomingCommandReceivedScenario.fail({message:"error in navigating to conversation with details - "+n}),e.responseDeferred.reject(s)})}else s.errorDetails="conversationId is empty",this.incomingCommandReceivedScenario.fail({reason:s.errorDetails}),this.responseDeferred.reject(s);return this.responseDeferred},e}();n.ReplyFromDesktopCommand=o},2332:function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var o=function(){function e(e,n,t){this.commandDetails=e,this.transportDependencyProviderService=n,this.incomingCommandReceivedScenario=t}return e.prototype.action=function(){var e=this,n=this.transportDependencyProviderService,t=n.$q,o=n.deepLinkService;this.responseDeferred=t.defer();var i=this.transportDependencyProviderService.getTransportConnectionHandler().getResponseDetails();return this.commandDetails.objectUrl&&this.commandDetails.fileId?o.resolveFileDeepLink(this.commandDetails).then(function(){e.incomingCommandReceivedScenario.stop(),e.responseDeferred.resolve(i)}).catch(function(n){i.errorDetails="deepLinkService rejected the promise",e.incomingCommandReceivedScenario.fail({message:i.errorDetails}),e.responseDeferred.reject(i)}):(i.errorDetails="ObjectUrl is empty - "+!this.commandDetails.objectUrl+" or fileId is empty - "+!this.commandDetails.fileId,this.incomingCommandReceivedScenario.fail({message:i.errorDetails}),this.responseDeferred.reject(i)),this.responseDeferred},e}();n.OpenFileCommand=o},2333:function(e,n,t){"use strict";var o=this&&this.__assign||function(){return(o=Object.assign||function(e){for(var n,t=1,o=arguments.length;t<o;t++){n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)};Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,n,t,o){this.commandDetails=e,this.endPointId=n,this.transportDependencyProviderService=t,this.incomingCommandReceivedScenario=o}return e.prototype.action=function(){var e=this.transportDependencyProviderService.$q;this.responseDeferred=e.defer();var n=this.transportDependencyProviderService.getTransportConnectionHandler(),t=n.getResponseDetails();return n.onUpdateEndpoint(this.commandDetails.previousEndpointId,this.endPointId)?(this.incomingCommandReceivedScenario.stop(),this.responseDeferred.resolve(t)):(t=o({errorDetails:"endpoint not changed, companion device with previousEndpoint is not in list of paired devices."},t),this.incomingCommandReceivedScenario.fail({message:t.errorDetails}),this.responseDeferred.reject(t)),this.responseDeferred},e}();n.UpdateEndpointCommand=i},2334:function(e,n,t){"use strict";var o=this&&this.__assign||function(){return(o=Object.assign||function(e){for(var n,t=1,o=arguments.length;t<o;t++){n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)};Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,n,t){this.commandDetails=e,this.transportDependencyProviderService=n,this.incomingCommandReceivedScenario=t}return e.prototype.action=function(){var e=this.transportDependencyProviderService,n=e.$q,t=e.eventingService;this.responseDeferred=n.defer();var i={callId:this.commandDetails.callId,conversationId:this.commandDetails.conversationId,messageId:this.commandDetails.messageId,conversationUrl:this.commandDetails.conversationUrl};if(this.transportDependencyProviderService.getTransportCallKeeper().isCallActiveOnTransport(i)){s=this.transportDependencyProviderService.getTransportConnectionHandler().getResponseDetails();t.$emit(this.transportDependencyProviderService.constants.events.calling.openSharingPanel),this.responseDeferred.resolve(s),this.incomingCommandReceivedScenario.stop()}else{var r="OpenShareCommand failed - Call not found with conversationId "+i.conversationId,s=o({errorDetails:r},this.transportDependencyProviderService.getTransportConnectionHandler().getResponseDetails());this.responseDeferred.reject(s),this.incomingCommandReceivedScenario.fail({message:r})}return this.responseDeferred},e}();n.OpenShareCommand=i},2335:function(e,n,t){"use strict";var o=this&&this.__assign||function(){return(o=Object.assign||function(e){for(var n,t=1,o=arguments.length;t<o;t++){n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)};Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,n,t){this.commandDetails=e,this.transportDependencyProviderService=n,this.incomingCommandReceivedScenario=t}return e.prototype.action=function(){var e=this,n=this.transportDependencyProviderService,t=n.$q,i=n.callingService;if(this.responseDeferred=t.defer(),!this.commandDetails.callId||!this.commandDetails.conversationId){var r="Call id or conversation id is undefined";this.transportDependencyProviderService.loggingService.error(r),this.incomingCommandReceivedScenario.fail({message:r});p=o({errorDetails:r},this.transportDependencyProviderService.getTransportConnectionHandler().getResponseDetails());this.responseDeferred.reject(p)}var s={callId:this.commandDetails.callId,conversationId:this.commandDetails.conversationId,messageId:this.commandDetails.messageId,conversationUrl:this.commandDetails.conversationUrl};this.transportDependencyProviderService.getTransportCallKeeper().removeActiveCall(s);var a=i.getActiveCalls();if(a){var c=a.filter(function(e){return e.conversationId===s.conversationId&&e.messageId==s.messageId});if(c&&c.length>0){var d=c[0];i.leaveCall(d,"EndCallCommand").then(function(){e.transportDependencyProviderService.loggingService.info("End call succeeded"),e.incomingCommandReceivedScenario.stop(),e.responseDeferred.resolve()}).catch(function(n){var t="Endcall failed with error "+n;e.transportDependencyProviderService.loggingService.error(t),e.incomingCommandReceivedScenario.fail({message:t});var i=o({errorDetails:t},e.transportDependencyProviderService.getTransportConnectionHandler().getResponseDetails());e.responseDeferred.reject(i)})}else{m="No call with callid "+this.commandDetails.callId;this.transportDependencyProviderService.loggingService.error(m),this.incomingCommandReceivedScenario.fail({message:m});p=o({errorDetails:m},this.transportDependencyProviderService.getTransportConnectionHandler().getResponseDetails());this.responseDeferred.reject(p)}return this.responseDeferred}var m="No active calls";this.transportDependencyProviderService.loggingService.error(m),this.incomingCommandReceivedScenario.fail({message:m});var p=o({errorDetails:m},this.transportDependencyProviderService.getTransportConnectionHandler().getResponseDetails());this.responseDeferred.reject(p)},e}();n.EndCallCommand=i;var r=function(){function e(e,n,t){this.commandDetails=e,this.transportDependencyProviderService=n,this.incomingCommandReceivedScenario=t}return e.prototype.action=function(){var e=this,n=this.transportDependencyProviderService,t=n.$q,i=n.callingService;if(this.responseDeferred=t.defer(),!this.commandDetails.callId||!this.commandDetails.conversationId){var r="Call id or conversation id is undefined";this.transportDependencyProviderService.loggingService.error(r),this.incomingCommandReceivedScenario.fail({message:r});var s=o({errorDetails:r},this.transportDependencyProviderService.getTransportConnectionHandler().getResponseDetails());this.responseDeferred.reject(s)}var a={isMicMuted:this.commandDetails.startCallOptions.isMicMuted,isVideoOn:this.commandDetails.startCallOptions.withVideo,isSpeakerMuted:this.commandDetails.startCallOptions.isSpeakerMuted,isCallOnHold:!1},c={callId:this.commandDetails.callId,conversationId:this.commandDetails.conversationId,messageId:this.commandDetails.messageId,conversationUrl:this.commandDetails.conversationUrl,callState:a},d=this.transportDependencyProviderService.getTransportCallKeeper();if(d.isCallActiveOnTransport(c)){var m="call is alread active on transport companion device";this.transportDependencyProviderService.loggingService.info(m),this.incomingCommandReceivedScenario.stop({message:m});var p=d.getTransportCallWithDetails(c),l=o({callId:p.callId,conversationId:p.conversationId,messageId:p.messageId,isBroadcast:!1,startCallOptions:{isMicMuted:p.callState.isMicMuted,isSpeakerMuted:p.callState.isSpeakerMuted,withVideo:p.callState.isVideoOn}},this.transportDependencyProviderService.getTransportConnectionHandler().getResponseDetails());this.responseDeferred.resolve(l)}else{this.transportDependencyProviderService.getTransportCallKeeper().addActiveCall(c);var v={conversationId:this.commandDetails.conversationId,startCallScenarioPromise:t.resolve(null),secondaryScenarios:[],withVideo:this.commandDetails.startCallOptions.withVideo,muted:this.commandDetails.startCallOptions.isMicMuted,callId:this.commandDetails.callId};i.startCall(v).then(function(n){e.transportDependencyProviderService.loggingService.info("Start call succeeded"),e.incomingCommandReceivedScenario.stop({message:"Start call succeeded"}),e.responseDeferred.resolve()}).catch(function(n){var t="Start call failed with error "+n;e.transportDependencyProviderService.loggingService.error(t),e.incomingCommandReceivedScenario.fail({message:t});var i=o({errorDetails:t},e.transportDependencyProviderService.getTransportConnectionHandler().getResponseDetails());e.responseDeferred.reject(i)})}return this.responseDeferred},e}();n.StartCallCommand=r;var s=function(){function e(e,n,t,o){this.commandDetails=e,this.transportDependencyProviderService=n,this.commandName=t,this.incomingCommandReceivedScenario=o}return e.prototype.action=function(){var e=this,n=this.transportDependencyProviderService,t=n.$q,i=n.callingService;if(this.responseDeferred=t.defer(),!this.commandDetails.callId||!this.commandDetails.conversationId){var r="Call id or conversation id is undefined";this.transportDependencyProviderService.loggingService.error(r),this.incomingCommandReceivedScenario.fail({message:r});u=o({errorDetails:r},this.transportDependencyProviderService.getTransportConnectionHandler().getResponseDetails());this.responseDeferred.reject(u)}var s,a={callId:this.commandDetails.callId,conversationId:this.commandDetails.conversationId,messageId:this.commandDetails.messageId,conversationUrl:this.commandDetails.conversationUrl},c=i.getAllCalls(!1,!1,!1),d=c?c.filter(function(e){return e.conversationId===a.conversationId&&e.messageId==a.messageId}):void 0,m=this.transportDependencyProviderService.getTransportCallKeeper().getCallStateForCall(a);if(d&&d.length>0){var p=d[0],l=!!p.intentId,v=l?3:1;switch(this.commandName){case teamspace.services.IncomingCommand.StopAudio:m.isSpeakerMuted=!0,m.isMicMuted=!0,this.transportDependencyProviderService.getTransportCallKeeper().setCallStateForCall(a,m),s=this.transportDependencyProviderService.callTogglingService.toggleMuteAudio(p,v,1,null,l);break;case teamspace.services.IncomingCommand.Mute:m.isMicMuted=!0,this.transportDependencyProviderService.getTransportCallKeeper().setCallStateForCall(a,m),s=this.transportDependencyProviderService.callTogglingService.toggleMuteAudio(p,v,1,null,l);break;case teamspace.services.IncomingCommand.StartAudio:m.isSpeakerMuted=!1,m.isMicMuted=!1,this.transportDependencyProviderService.getTransportCallKeeper().setCallStateForCall(a,m),s=this.transportDependencyProviderService.callTogglingService.toggleMuteAudio(p,v,2,null,l);break;case teamspace.services.IncomingCommand.Unmute:m.isMicMuted=!1,this.transportDependencyProviderService.getTransportCallKeeper().setCallStateForCall(a,m),s=this.transportDependencyProviderService.callTogglingService.toggleMuteAudio(p,v,2,null,l);break;case teamspace.services.IncomingCommand.StartVideo:m.isVideoOn=!0,this.transportDependencyProviderService.getTransportCallKeeper().setCallStateForCall(a,m),s=this.transportDependencyProviderService.callTogglingService.toggleVideo(p,"Companion device",!0);break;case teamspace.services.IncomingCommand.StopVideo:m.isVideoOn=!1,this.transportDependencyProviderService.getTransportCallKeeper().setCallStateForCall(a,m),s=this.transportDependencyProviderService.callTogglingService.toggleVideo(p,"Companion device",!1);break;case teamspace.services.IncomingCommand.HoldCall:m.isCallOnHold=!0,this.transportDependencyProviderService.getTransportCallKeeper().setCallStateForCall(a,m),s=this.transportDependencyProviderService.callTogglingService.toggleHold(p,"Companion device",1);break;case teamspace.services.IncomingCommand.UnholdCall:m.isCallOnHold=!1,this.transportDependencyProviderService.getTransportCallKeeper().setCallStateForCall(a,m),s=this.transportDependencyProviderService.callTogglingService.toggleHold(p,"Companion device",2)}}else{var g="Command "+this.commandName+" failed - Call not found with conversationId "+a.conversationId;this.transportDependencyProviderService.loggingService.error(g),this.incomingCommandReceivedScenario.fail({message:g});var u=o({errorDetails:g},this.transportDependencyProviderService.getTransportConnectionHandler().getResponseDetails());this.responseDeferred.reject(u)}return s&&s.then(function(){e.incomingCommandReceivedScenario.stop(),e.transportDependencyProviderService.$timeout(function(){return e.responseDeferred.resolve(null)},0)}).catch(function(n){var t="Command "+e.commandName+" failed with error "+n;e.transportDependencyProviderService.loggingService.error(t),e.incomingCommandReceivedScenario.fail({message:t});var i=o({errorDetails:t},e.transportDependencyProviderService.getTransportConnectionHandler().getResponseDetails());e.responseDeferred.reject(i)}),this.responseDeferred},e}();n.BaseCallToggleStateCommand=s},2336:function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var o=function(){function e(e,n,t){this.commandDetails=e,this.transportDependencyProviderService=n,this.incomingCommandReceivedScenario=t}return e.prototype.action=function(){var e=this,n=this.transportDependencyProviderService,t=n.$q,o=n.constants,i=n.settingsService,r=this.transportDependencyProviderService.getTransportConnectionHandler(),s=this.transportDependencyProviderService.getBrbV2FeedbackService(),a=t.defer(),c=r.getResponseDetails();if(!i.valueAsBoolean(o.settings.names.enableBetterTogetherReportProblemSynching)){d="Error: Report Problem Synching not activated in settings. Please set enableBetterTogetherReportProblemSynching to true.";return c.errorDetails=d,this.incomingCommandReceivedScenario.fail({message:c.errorDetails}),a.reject(c),a}if(!s){var d="Error: brbV2FeedbackService is not loaded. Unable to sync up logs.";return c.errorDetails=d,a.reject(c),this.incomingCommandReceivedScenario.fail({message:d}),a}return s.extendFeedbackReport(this.commandDetails.brbContainerId,{category:"Better Together",title:"Addition of logfiles by laptop for Better Together problem report",description:"Addition of logfiles for endpointId "+this.commandDetails.targetEndpointId},!0).then(function(){e.incomingCommandReceivedScenario.stop(),a.resolve(c)}).catch(function(n){e.incomingCommandReceivedScenario.fail({message:n}),c.errorDetails=n,a.reject(c)}),a},e}();n.ReportProblemIncomingCommand=o},2337:function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var o=t(2338),i=t(2339),r=t(2340),s=t(2341),a=t(2342),c=t(2343),d=t(2344),m=function(){function e(e){this.transportDependencyProviderService=e,this.logger=e.loggingService.newLogger("OutgoingCommandFactory")}return e.prototype.generateCauseId=function(){return this.transportDependencyProviderService.utilityService.generateUUID()},e.prototype.createCommand=function(e,n,t,m){var p;if(this.transportDependencyProviderService.appStateService.hasMachineState(teamspace.services.MachineState.MachineLocked)&&e!=teamspace.services.OutgoingCommand.Lock)return this.logger.error("Machine is in locked state. Outgoing command with name - "+e+" will not be created."),m.fail({message:"Machine is in locked state. Outgoing command with name - "+e+" will not be created."}),null;e=e.toLowerCase();var l=this.generateCauseId();switch(e){case teamspace.services.OutgoingCommand.Response:p=new o.ResponseCommand(l,t,n,this.transportDependencyProviderService,m);break;case teamspace.services.OutgoingCommand.KeepAlive:p=new i.KeepAliveCommand(l,t,n,this.transportDependencyProviderService,m);break;case teamspace.services.OutgoingCommand.Lock:p=new r.LockCommand(l,t,n,this.transportDependencyProviderService,m);break;case teamspace.services.OutgoingCommand.Unlock:p=new s.UnlockCommand(l,t,n,this.transportDependencyProviderService,m);break;case teamspace.services.OutgoingCommand.Unpair:p=new a.UnpairCommand(l,t,n,this.transportDependencyProviderService,m);break;case teamspace.services.OutgoingCommand.StartCall:p=new c.StartCallOutgoingCommand(l,t,n,this.transportDependencyProviderService,m);break;case teamspace.services.OutgoingCommand.EndCall:p=new c.EndCallOutgoingCommand(l,t,n,this.transportDependencyProviderService,m);break;case teamspace.services.OutgoingCommand.Mute:case teamspace.services.OutgoingCommand.Unmute:case teamspace.services.OutgoingCommand.StartAudio:case teamspace.services.OutgoingCommand.StopAudio:case teamspace.services.OutgoingCommand.StartVideo:case teamspace.services.OutgoingCommand.StopVideo:case teamspace.services.OutgoingCommand.HoldCall:case teamspace.services.OutgoingCommand.UnholdCall:p=new c.BaseCallCommand(l,t,n,this.transportDependencyProviderService,m);break;case teamspace.services.OutgoingCommand.ReportProblem:p=new d.ReportProblemOutgoingCommand(l,t,n,this.transportDependencyProviderService,m);break;default:return m.fail({message:"Outgoing Command not created for "+p+". Command not compatible or implemented"}),null}return p.name=e,p.startTime=new Date,p.isRetry=!1,p},e}();n.OutgoingCommandFactory=m},2338:function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var o=function(){function e(e,n,t,o,i){this.causeId=e,this.endpoint=n,this.commandDetails=t,this.sendOutgoingCommandScenario=i,t.companionResponseRequired=!1;var r=o.$q;this.onResponseReceived=r.defer(),this.onCommandReadyToSend=r.defer(),this.onCommandReadyToSend.resolve(!0);var s=this.onCommandExecuted.bind(this);this.onResponseReceived.promise.then(s).catch(s)}return e.prototype.onCommandExecuted=function(e){if(e&&!e.errorDetails)this.sendOutgoingCommandScenario.stop();else{var n="";n=e?"command failed, Error response: "+e.errorDetails:"NULL response received",this.sendOutgoingCommandScenario.fail({message:n})}},e}();n.ResponseCommand=o},2339:function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var o=function(){function e(e,n,t,o,i){this.causeId=e,this.endpoint=n,this.commandDetails=t,this.sendOutgoingCommandScenario=i,t.companionResponseRequired=!0;var r=o.$q,s=this.onCommandExecuted.bind(this);this.onResponseReceived=r.defer(),this.onResponseReceived.promise.then(s).catch(s),this.onCommandReadyToSend=r.defer(),this.onCommandReadyToSend.resolve(!0)}return e.prototype.onCommandExecuted=function(e){if(e&&!e.errorDetails)this.sendOutgoingCommandScenario.stop();else{var n="";n=e?"KeepAlive command failed, Error response: "+e.errorDetails:"NULL response received",this.sendOutgoingCommandScenario.fail({message:n})}},e}();n.KeepAliveCommand=o},2340:function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var o=function(){function e(e,n,t,o,i){this.causeId=e,this.endpoint=n,this.commandDetails=t,this.transportDependencyProviderService=o,this.sendOutgoingCommandScenario=i,t.companionResponseRequired=!1,this.onResponseReceived=o.$q.defer(),this.onCommandReadyToSend=o.$q.defer(),this.onCommandReadyToSend.resolve(!0);var r=this.onCommandExecuted.bind(this);this.onResponseReceived.promise.then(r).catch(r)}return e.prototype.onCommandExecuted=function(e){if(e&&!e.errorDetails)this.transportDependencyProviderService.getTransportConnectionHandler().onDeviceLocked(this.endpoint.getEndpointId()),this.transportDependencyProviderService.loggingService.info("companion device locked"),this.sendOutgoingCommandScenario.stop();else{var n="";n=e?"Lock command failed, Error response: "+e.errorDetails:"NULL response received",this.transportDependencyProviderService.loggingService.error(n),this.sendOutgoingCommandScenario.fail({message:n})}},e}();n.LockCommand=o},2341:function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var o=function(){function e(e,n,t,o,i){this.causeId=e,this.endpoint=n,this.commandDetails=t,this.transportDependencyProviderService=o,this.sendOutgoingCommandScenario=i,t.companionResponseRequired=!0,this.onResponseReceived=o.$q.defer(),this.onCommandReadyToSend=o.$q.defer(),this.onCommandReadyToSend.resolve(!0);var r=this.onCommandExecuted.bind(this);this.onResponseReceived.promise.then(r).catch(r)}return e.prototype.onCommandExecuted=function(e){if(e&&!e.errorDetails)this.transportDependencyProviderService.getTransportConnectionHandler().onDeviceUnlocked(this.endpoint.getEndpointId()),this.transportDependencyProviderService.loggingService.error("companion device unlocked"),this.sendOutgoingCommandScenario.stop();else{var n="";n=e?"Unlock command failed, Error response: "+e.errorDetails:"NULL response received",this.transportDependencyProviderService.loggingService.error(n),this.sendOutgoingCommandScenario.fail({message:n})}},e}();n.UnlockCommand=o},2342:function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var o=function(){function e(e,n,t,o,i){this.causeId=e,this.endpoint=n,this.commandDetails=t,this.transportDependencyProviderService=o,this.sendOutgoingCommandScenario=i,t.companionResponseRequired=!1;var r=o.$q;this.onResponseReceived=r.defer();var s=this.onCommandExecuted.bind(this);this.onResponseReceived.promise.then(s).catch(s),this.onCommandReadyToSend=r.defer(),this.onCommandReadyToSend.resolve(!0)}return e.prototype.onCommandExecuted=function(e){if(e&&!e.errorDetails)this.sendOutgoingCommandScenario.stop();else{var n="unpair command failed for endpoint : "+this.endpoint.getEndpointId();this.sendOutgoingCommandScenario.fail({message:n}),this.transportDependencyProviderService.loggingService.error(n)}},e}();n.UnpairCommand=o},2343:function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var o=function(){function e(e,n,t,o,i){this.causeId=e,this.endpoint=n,this.commandDetails=t,this.transportDependencyProviderService=o,this.sendOutgoingCommandScenario=i,t.companionResponseRequired=!0,this.onResponseReceived=o.$q.defer(),this.onCommandReadyToSend=o.$q.defer(),this.onCommandReadyToSend.resolve(!0);var r=this.onCommandExecuted.bind(this);this.onResponseReceived.promise.then(r).catch(r)}return e.prototype.onCommandExecuted=function(e){if(e&&!e.errorDetails)this.sendOutgoingCommandScenario.stop({message:"Completed command "+this.name+" for call id "+this.commandDetails.callId});else{var n="";n=e?this.name+" command failed for call id "+this.commandDetails.callId+", Error response: "+e.errorDetails:"NULL response received",this.sendOutgoingCommandScenario.fail({message:n}),this.transportDependencyProviderService.loggingService.error(n)}},e}();n.BaseCallCommand=o;var i=function(){function e(e,n,t,o,i){this.causeId=e,this.endpoint=n,this.commandDetails=t,this.transportDependencyProviderService=o,this.sendOutgoingCommandScenario=i,t.companionResponseRequired=!0,this.onResponseReceived=o.$q.defer(),this.onCommandReadyToSend=o.$q.defer(),this.onCommandReadyToSend.resolve(!0);var r=this.onCommandExecuted.bind(this);this.onResponseReceived.promise.then(r).catch(r)}return e.prototype.onCommandExecuted=function(e){if(e&&!e.errorDetails){var n={isMicMuted:e.startCallOptions?e.startCallOptions.isMicMuted:this.commandDetails.startCallOptions.isMicMuted,isVideoOn:e.startCallOptions?e.startCallOptions.withVideo:this.commandDetails.startCallOptions.withVideo,isSpeakerMuted:e.startCallOptions?e.startCallOptions.isSpeakerMuted:this.commandDetails.startCallOptions.isSpeakerMuted,isCallOnHold:!1},t={callId:this.commandDetails.callId,conversationId:e.conversationId,messageId:e.messageId,conversationUrl:e.conversationUrl,callState:n};this.transportDependencyProviderService.getTransportCallKeeper().addActiveCall(t),this.sendOutgoingCommandScenario.stop({message:"Call with callid started on companion device "+this.commandDetails.callId})}else{var o="";o=e?"Start call command failed, Error response: "+e.errorDetails:"NULL response received",this.sendOutgoingCommandScenario.fail({message:o}),this.transportDependencyProviderService.loggingService.error(o)}},e}();n.StartCallOutgoingCommand=i;var r=function(){function e(e,n,t,o,i){this.causeId=e,this.endpoint=n,this.commandDetails=t,this.transportDependencyProviderService=o,this.sendOutgoingCommandScenario=i,t.companionResponseRequired=!0,this.onResponseReceived=o.$q.defer(),this.onCommandReadyToSend=o.$q.defer(),this.onCommandReadyToSend.resolve(!0);var r=this.onCommandExecuted.bind(this);this.onResponseReceived.promise.then(r).catch(r)}return e.prototype.onCommandExecuted=function(e){if(e&&!e.errorDetails){var n={callId:this.commandDetails.callId,conversationId:this.commandDetails.conversationId,messageId:this.commandDetails.messageId,conversationUrl:this.commandDetails.conversationUrl};this.transportDependencyProviderService.getTransportCallKeeper().removeActiveCall(n),this.sendOutgoingCommandScenario.stop({message:"Call with callid stopped on companion device "+this.commandDetails.callId})}else{var t="";t=e?"End call command failed, Error response: "+e.errorDetails:"NULL response received",this.sendOutgoingCommandScenario.fail({message:t}),this.transportDependencyProviderService.loggingService.error(t)}},e}();n.EndCallOutgoingCommand=r},2344:function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var o=function(){function e(e,n,t,o,i){this.causeId=e,this.endpoint=n,this.commandDetails=t,this.transportDependencyProviderService=o,this.sendOutgoingCommandScenario=i,t.companionResponseRequired=!1;var r=o.$q,s=this.onCommandExecuted.bind(this);this.onResponseReceived=r.defer(),this.onResponseReceived.promise.then(s).catch(s),this.onCommandReadyToSend=r.defer(),this.onCommandReadyToSend.resolve(!0)}return e.prototype.onCommandExecuted=function(e){if(e&&!e.errorDetails)this.transportDependencyProviderService.loggingService.info("Outgoing report problem command for brbContainerId "+this.commandDetails.brbContainerId+" successful for endpoint: "+this.endpoint.getEndpointId()+"."),this.sendOutgoingCommandScenario.stop();else{var n=e&&e.errorDetails?e.errorDetails:"<No message>",t="Outgoing report problem command for brbContainerId "+this.commandDetails.brbContainerId+" failed for endpoint: "+this.endpoint.getEndpointId()+". Error: "+n;this.sendOutgoingCommandScenario.fail({message:t,message1:t}),this.transportDependencyProviderService.loggingService.error(t)}},e}();n.ReportProblemOutgoingCommand=o},2345:function(e,n,t){"use strict";var o=this&&this.__assign||function(){return(o=Object.assign||function(e){for(var n,t=1,o=arguments.length;t<o;t++){n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)};Object.defineProperty(n,"__esModule",{value:!0});var i;!function(e){e.InitState="InitState",e.IsScanRunning="IsScanRunning",e.LastKeepAliveSentForSession="LastKeepAliveSentForSession",e.IsSendingKeepAlives="IsSendingKeepAlives",e.HasConnectedDevices="HasConnectedDevices",e.HasPairedDevices="HasPairedDevices",e.PairedDeviceCount="PairedDeviceCount",e.IsContinousScanRunning="IsContinousScanRunning"}(i=n.TransportConnectionHandlerStates||(n.TransportConnectionHandlerStates={}));var r=function(){function e(e,n){this.transportDependencyProviderService=e,this.transportCommandRouter=n,this.keepAliveInterval=3e4,this.deviceNotFoundThreshold=15e3,this.continousScanInterval=18e3,this.currentSalt=0,this.ComponentName="TransportConnectionHandler",this.keepAliveTimer=void 0,this.logger=e.loggingService.newLogger(this.ComponentName),this.constants=e.constants,this.storageService=e.storageService,this.bluetoothLEService=e.bluetoothLEService,this.logger.info("connectionHandler object successfully created, initialization is still pending.")}return e.prototype.initializeConnectionHandler=function(){var e=this;this.logger.info("initializing states and Ipc listeners, and rehydrating previous connection."),this.setupInitialStates(),this.setupIpcForMachineState(),this.ipcRenderer?(this.ipcRenderer.once(this.constants.events.desktopApp.getLockState,function(n,t){e.logger.info("state of machine is "+t),t===e.constants.desktopApp.lockState.unlocked&&(e.logger.info("machine is in unlocked state."),e.rehydratePreviousConnection(!1,"TransportConnectionHandler is initialized"))}),this.ipcRenderer.send(this.constants.events.desktopApp.getLockState)):this.logger.error("ipcRenderer is not available"),this.states.set(i.InitState,teamspace.services.ITransportComponentState.Initialized),this.logger.info("connectionHandler successfully initialized")},e.prototype.onNewDevicePaired=function(n){this.logger.info("Caching new device paired");var t,o=this.getAllPairedDevices();o&&(t=o.filter(function(e){return e.endPointId!==n.endPointId})),o=t?t.concat(n):[n],this.storageService.set(e.BTPairedDevicesKey,o),this.storageService.set(e.LastPairedDeviceEndpointKey,n.endPointId),this.transportDependencyProviderService.setPairedDeviceInDeviceManager(),this.setupKeepAlive(n.endPointId)},e.prototype.onDeviceUnpaired=function(n){var t=this.getAllPairedDevices();if(t){var o=t.find(function(e){return e.endPointId===n});if(o){o.connectionStatus===teamspace.services.PairedConnectionStatus.Connected&&(this.disconnect(!0,!1),this.storageService.set(e.LastPairedDeviceEndpointKey,""),this.storageService.set(e.LastSaltUpdateTimeKey,"0"));var i=t.filter(function(e){return e.endPointId!==n});return this.storageService.set(e.BTPairedDevicesKey,i),this.transportDependencyProviderService.setPairedDeviceInDeviceManager(),this.logger.info("Device unpaired"),!0}this.logger.error("Device not found in list of pairedDevices")}else this.logger.error("No paired devices found");return!1},e.prototype.unpairDevice=function(e){var n=this.getAllPairedDevices();if(n&&n.find(function(n){return n.endPointId===e})){var t=this.getCommandDetails();this.transportCommandRouter.sendOutgoingCommand(teamspace.services.OutgoingCommand.Unpair,t,e),this.onDeviceUnpaired(e)}},e.prototype.onDeviceLocked=function(n){if(!n)return this.logger.error("Cannot mark device as locked, endpointid is null"),!1;var t=this.getAllPairedDevices();if(t){var o=t.find(function(e){return e.endPointId===n});if(o)return o.connectionStatus=teamspace.services.PairedConnectionStatus.Locked,this.storageService.set(e.BTPairedDevicesKey,t),this.storageService.set(e.LastPairedDeviceEndpointKey,o.endPointId),this.transportDependencyProviderService.setPairedDeviceInDeviceManager(),this.logger.info("Paired device status set to: locked"),!0;this.logger.error("Device not found in list of pairedDevices")}else this.logger.error("No paired devices found");return!1},e.prototype.onDeviceUnlocked=function(n){if(!n)return this.logger.error("Cannot mark device as unlocked, endpointid is null"),!1;var t=this.getAllPairedDevices();if(t){var o=t.find(function(e){return e.endPointId===n});if(o)return o.connectionStatus=teamspace.services.PairedConnectionStatus.Connected,this.storageService.set(e.BTPairedDevicesKey,t),this.storageService.set(e.LastPairedDeviceEndpointKey,o.endPointId),this.transportDependencyProviderService.setPairedDeviceInDeviceManager(),this.logger.info("Paired device status set to: unlocked and connected"),!0;this.logger.error("Device not found in list of pairedDevices")}else this.logger.error("Device unlocked but no paired devices found");return!1},e.prototype.onUpdateEndpoint=function(n,t){var o=this.getAllPairedDevices();if(o){var i=o.find(function(e){return e.endPointId===n});if(i)return i.endPointId=t,this.storageService.set(e.BTPairedDevicesKey,o),this.transportCommandRouter.endSession(n),this.transportCommandRouter.startSession(t),this.logger.info("endpoint id updated successfully. previousEndpointId - "+n+", newEndpointId - "+t),!0;this.logger.error("Device not found in list of pairedDevices. previousEndpointId - "+n+", newEndpointId - "+t)}else this.logger.error("No paired devices found. previousEndpointId - "+n+", newEndpointId - "+t);return!1},e.prototype.getConnectedDevice=function(){var e=this.getAllPairedDevices();if(e)return e.find(function(e){return e.connectionStatus===teamspace.services.PairedConnectionStatus.Connected})},e.prototype.continousCheckProximity=function(e){var n=this;void 0===e&&(e=!1),this.continousCheckProximityInterval?this.logger.error("A continous check for proximity is already running, isReconnectCallback is - "+e):this.continousCheckProximityInterval=setInterval(function(){n.continousCheckProximityDeferred=n.checkProximity(),e?n.continousCheckProximityDeferred.promise.then(n.reconnectCallback):n.continousCheckProximityDeferred.promise.catch(function(){n.logger.info("checkProximity failed, dont have a reconnectCallback function")})},this.continousScanInterval)},e.prototype.checkProximity=function(){var e=this;this.logger.info("Attempting Proximity check");var n=this.transportDependencyProviderService.$q,t=n.defer(),o=this.bluetoothLEService;return this.transportDependencyProviderService.canInitializeTransport()?(teamspace.services.QCancelable.toCancelablePromise(n,o.onceInitialized()).then(function(){if(!o.isBLEsupported||!o.isBluetoothRadioOn){var n="Bluetooth scan was not started. BLE might not be supported";return e.logger.error(n),t.reject(n),t}e.logger.info("Scan started for better together companion devices."),e.states.set(i.IsScanRunning,!0);var r,s=setTimeout(function(){o.unsubscribe(r),e.logger.log("Unsubscribed for blehandle "+r+" due to timeout."),t.resolve(!1),e.logger.error("Timeout reached. Device not found. Scan stopped"),e.states.set(i.IsScanRunning,!1)},e.deviceNotFoundThreshold);r=o.subscribe(function(n,o){e.onCompanionDevicesFound(o,t,r,s)},e.constants.events.bluetoothLE.adjacent,e.constants.events.bluetoothLE.companionDiscovery)}).catch(function(n){n="Bluetooth scan was not started. BLE might not be supported due to error - "+n.toString(),e.logger.error(n),t.reject(n),e.states.set(i.IsScanRunning,!1)}),t):(t.reject("transportation can not be initialised"),t)},e.prototype.verifySalt=function(e){return e.salt[0]===this.currentSalt||!!e.salt[1]&&e.salt[1]===this.currentSalt},e.prototype.getCommandDetails=function(){return{salt:[this.currentSalt]}},e.prototype.getResponseDetails=function(){return{salt:[this.currentSalt]}},e.prototype.getStates=function(){var e=this.getAllPairedDevices(),n=this.getConnectedDevice();return this.states.set(i.HasConnectedDevices,!!n),this.states.set(i.HasPairedDevices,e&&e.length>0),this.states.set(i.PairedDeviceCount,e?e.length:0),this.states},e.prototype.setupInitialStates=function(){this.states=new Map,this.states.set(i.InitState,teamspace.services.ITransportComponentState.Uninitialized),this.states.set(i.IsScanRunning,!1),this.states.set(i.LastKeepAliveSentForSession,""),this.states.set(i.IsSendingKeepAlives,!1)},e.prototype.getAllPairedDevices=function(){return this.storageService.get(e.BTPairedDevicesKey)},e.prototype.rehydratePreviousConnection=function(n,t){var i=this,r=this.getAllPairedDevices();if(r&&r.length>0){this.logger.info("Rehydrating transport connection"),this.setAllPairedDevicesAsDisconnected();var s=this.storageService.get(e.LastSaltUpdateTimeKey);if((s=(new Date).getTime()-s)<6e4&&n){var a=this.storageService.get(e.LastPairedDeviceEndpointKey);this.logger.info("sending unlock command using quick strategy, lastSaltUpdateTime is "+s+", reason - "+t);var c=o({reason:"sending unlock command using quick strategy, lastSaltUpdateTime is "+s+", reason - "+t},this.getCommandDetails()),d=this.transportCommandRouter.sendOutgoingCommand(teamspace.services.OutgoingCommand.Unlock,c,a);if(!d){var m="unlock command not created for quick unlock strategy, trying with long unlock strategy, reason - "+t;this.logger.error(m),this.reconnectCallback=this.findProximalDeviceAndReconnect.bind(this,m),this.continousCheckProximity(!0)}d.promise.then(function(){i.logger.info("Unlock succeeded with quick unlock strategy"),i.reconnect(a,!1)}).catch(function(e){var n="unlock command failed due to error - "+e+" in quick unlock strategy, reason - "+t;i.logger.error(n),i.reconnectCallback=i.findProximalDeviceAndReconnect.bind(i,n),i.continousCheckProximity(!0)})}else{var p="salt is not updated, trying to unlock by long unlock strategy, reason - "+t;this.logger.info(p),this.reconnectCallback=this.findProximalDeviceAndReconnect.bind(this,p),this.continousCheckProximity(!0)}}},e.prototype.onCompanionDevicesFound=function(e,n,t,o){var r=this;if(e){var s=e.data,a=this.transportDependencyProviderService,c=a.authenticationService,d=a.utilityService;c.getUserInformation().then(function(e){var a=d.packetGUID2String(s);e.profile.oid===a&&(r.logger.info("Better together companion device found and bleHandle is "+t+". Unsubscribing now"),r.bluetoothLEService.unsubscribe(t),r.updateSalt(s),clearTimeout(o),r.states.set(i.IsScanRunning,!1),n.resolve(!0))}).catch(function(e){r.logger.error("device with incorrect authentication sent payload"+e)})}},e.prototype.findProximalDeviceAndReconnect=function(e,n){var t=this;if(n){this.logger.info("Paired device in proximity. Will attempt keep alive to all paired devices");var o=this.getAllPairedDevices(),r=this.getCommandDetails();o&&0!==o.length&&o.forEach(function(n){t.logger.info("Sending keep alive to get status from "+n.endPointId);var o=t.transportCommandRouter.sendOutgoingCommand(teamspace.services.OutgoingCommand.KeepAlive,r,n.endPointId);o&&o.promise.then(function(o){t.logger.info("Keep alive successful from "+n.endPointId),t.reconnect(n.endPointId,!0,"keepAlive successful, reason - "+e),t.states.set(i.LastKeepAliveSentForSession,new Date)})})}},e.prototype.reconnect=function(e,n,t){var i=this;if(this.transportDependencyProviderService.appStateService.hasMachineState(teamspace.services.MachineState.MachineLocked))return this.logger.info("machine is in locked state, cancelling reconnect."),!1;if(this.logger.info("Reconnecting to endpoint "+e),!this.getAllPairedDevices().find(function(n){return n.endPointId===e}))return!1;var r=this.transportDependencyProviderService.$q.defer();if(n){var s=o({reason:"trying to send a unlock command from reconnect function, reason - "+t},this.getCommandDetails());r=this.transportCommandRouter.sendOutgoingCommand(teamspace.services.OutgoingCommand.Unlock,s,e)}else r.resolve();return r.promise.then(function(){i.onDeviceUnlocked(e),i.transportCommandRouter.startSession(e),i.setupKeepAlive(e),i.cleanUpContinousProximityScan()}),!0},e.prototype.disconnect=function(n,t,r){void 0===n&&(n=!1),void 0===t&&(t=!1),this.logger.info("Disconnecting from paired device.");var s=this.getAllPairedDevices(),a=s?s.find(function(e){return e.connectionStatus===teamspace.services.PairedConnectionStatus.Connected}):void 0;if(a){if(clearInterval(this.keepAliveTimer),this.keepAliveTimer=void 0,this.keepAliveDeferred&&this.keepAliveDeferred.reject("keepAlive deferred cancelled in disconnect function."),this.states.set(i.IsSendingKeepAlives,!1),!n){var c=o({reason:"sending lock command from disconnect function, reason - "+r},this.getCommandDetails());this.transportCommandRouter.sendOutgoingCommand(teamspace.services.OutgoingCommand.Lock,c)}a.connectionStatus=teamspace.services.PairedConnectionStatus.PairedNotConnected,this.storageService.set(e.LastPairedDeviceEndpointKey,a.endPointId),this.setAllPairedDevicesAsDisconnected(),this.transportCommandRouter.endSession(a.endPointId),t&&this.keepScanOn()}},e.prototype.setAllPairedDevicesAsDisconnected=function(){var n=this.getAllPairedDevices();n.forEach(function(e){e.connectionStatus=teamspace.services.PairedConnectionStatus.PairedNotConnected}),this.storageService.set(e.BTPairedDevicesKey,n),this.transportDependencyProviderService.setPairedDeviceInDeviceManager()},e.prototype.onProximityLost=function(){this.logger.error("Proximity lost. Stopping keep alive and starting continous scan for autopair"),this.disconnect(!1,!1,"On proximity lost."),this.rehydratePreviousConnection(!1,"On proximity lost")},e.prototype.setupKeepAlive=function(e){var n=this;this.keepAliveTimer||(this.logger.info("Setting up keep alive"),this.states.set(i.IsSendingKeepAlives,!0),this.keepAliveTimer=setInterval(function(){n.sendKeepAlive(e).promise.catch(function(t){n.logger.error("keep alive failed for 1st time - error "+t),n.onKeepAliveCheckFailed(e)})},this.keepAliveInterval))},e.prototype.onKeepAliveCheckFailed=function(e){var n=this;clearInterval(this.keepAliveTimer),this.keepAliveTimer=void 0,this.sendKeepAlive().promise.then(function(){n.setupKeepAlive(e)}).catch(function(){n.logger.error("Proximity lost, KeepAlive failed 2 times."),n.onProximityLost()})},e.prototype.sendKeepAlive=function(e){var n=this,t=this.transportDependencyProviderService.$q;return this.keepAliveDeferred=t.defer(),this.logger.info("checking proximity when trying to send keepAlive command"),this.checkProximity().promise.then(function(t){if(t){var o=n.getCommandDetails(),r=n.transportCommandRouter.sendOutgoingCommand(teamspace.services.OutgoingCommand.KeepAlive,o,e);n.states.set(i.LastKeepAliveSentForSession,new Date),r.promise.then(function(){n.keepAliveDeferred.resolve("keepAlive successfull")}).catch(function(e){n.logger.error("keepAlive command failed, because of error - "+e),n.keepAliveDeferred.reject("keepAlive command failed, because of error - "+e)})}else n.keepAliveDeferred.reject("checkProximity failed, device not in proximity")}).catch(function(e){n.keepAliveDeferred.reject("sending keepAlive failed with error - "+e)}),this.keepAliveDeferred},e.prototype.updateSalt=function(n){if(n.length>18){var t=n[18]<<8|n[17];if(this.currentSalt!==t){this.currentSalt=t;var o=new Date;this.storageService.set(e.LastSaltUpdateTimeKey,o.getTime()),this.logger.info("Salt updated")}}},e.prototype.keepScanOn=function(){this.logger.log("Starting continous scan for keeping scan on for quick unlock strategy"),this.continousCheckProximity()},e.prototype.setupIpcForMachineState=function(){var e=this;this.ipcRenderer=window.electronSafeIpc,this.ipcRenderer&&this.transportDependencyProviderService.canInitializeTransport()?(this.ipcEventHandler=function(n,t){t===e.constants.events.desktopApp.machineLock?(e.logger.info("Got machine locked event"),e.cleanUpContinousProximityScan(),e.disconnect(!1,!0,"Got machine locked event")):t===e.constants.events.desktopApp.machineUnlock&&(e.logger.info("Got machine unlocked event"),e.cleanUpContinousProximityScan(),e.rehydratePreviousConnection(!0,"Got machine unlocked event"))},this.ipcEventHandler=this.ipcEventHandler.bind(this),this.ipcRenderer.on(this.constants.events.desktopApp.machineInactiveResponse,this.ipcEventHandler)):this.logger.error("ipcRenderer is not defined.")},e.prototype.cleanUpConnectionHandler=function(){this.logger.info("clean up of connectionHandler has been called. disconnecting the current device and removing all listeners to ipcRenderer"),this.disconnect(!1,!1,"cleanup of connectionHandler has been called."),this.cleanUpContinousProximityScan(),this.ipcRenderer.removeListener(this.constants.events.desktopApp.machineInactiveResponse,this.ipcEventHandler),this.transportCommandRouter=void 0},e.prototype.cleanUpContinousProximityScan=function(){var e="cleaning up continousProximityScan related promise and bleHandle.";this.logger.info(e),clearInterval(this.continousCheckProximityInterval),this.continousCheckProximityDeferred&&this.continousCheckProximityDeferred.reject(e),this.continousCheckProximityInterval=void 0},e.BTPairedDevicesKey="BTPairedDevices",e.LastSaltUpdateTimeKey="LastSaltUpdateTime",e.LastPairedDeviceEndpointKey="LastPairedDeviceEndpoint",e}();n.TransportConnectionHandler=r},2346:function(e,n,t){"use strict";var o=this&&this.__assign||function(){return(o=Object.assign||function(e){for(var n,t=1,o=arguments.length;t<o;t++){n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)};Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,n){this.transportCommandRouter=e,this.transportConnectionHandler=n}return e.prototype.sendReportProblemId=function(e){var n=this,t=o({brbContainerId:e},this.transportConnectionHandler.getCommandDetails());this.transportConnectionHandler.getAllPairedDevices().map(function(e){n.transportCommandRouter.sendOutgoingCommand(teamspace.services.OutgoingCommand.ReportProblem,t,e.endPointId)})},e}();n.TransportAgentHandler=i},2347:function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var o;!function(e){e.InitState="InitState",e.ActiveCallDetails="ActiveCallDetails"}(o||(o={}));var i=function(){function e(e){this.logger=e.loggingService.newLogger("TransportCallkeeper"),this.activeCompanionDeviceCalls=[],this.states=new Map,this.logger.info("TransportCallkeeper initialized."),this.states.set(o.InitState,teamspace.services.ITransportComponentState.Initialized)}return e.prototype.addActiveCall=function(e){this.activeCompanionDeviceCalls.push(e),this.logger.info("Added active call with callId: "+e.callId+", conversationId: "+e.conversationId+", messageId: "+e.messageId)},e.prototype.removeActiveCall=function(e){this.activeCompanionDeviceCalls=this.activeCompanionDeviceCalls.filter(function(n){return n.conversationId!==e.conversationId&&n.messageId!=e.messageId}),this.logger.info("Removed call with callId: "+e.callId+", conversationId: "+e.conversationId+", messageId: "+e.messageId)},e.prototype.isCallActiveOnTransport=function(e){return-1!==this.activeCompanionDeviceCalls.findIndex(function(n){return n.conversationId===e.conversationId&&n.messageId===n.messageId})},e.prototype.getTransportCallWithDetails=function(e){return this.activeCompanionDeviceCalls.find(function(n){return n.conversationId===e.conversationId&&n.messageId===n.messageId})},e.prototype.getCallStateForCall=function(e){var n=this.getTransportCallWithDetails(e);return n?n.callState:void 0},e.prototype.setCallStateForCall=function(e,n){this.activeCompanionDeviceCalls.find(function(n){return n.conversationId===e.conversationId&&n.messageId==e.messageId}).callState=n,this.logger.info("Updated call state for the transport call with callId: "+e.callId+", conversationId: "+e.conversationId+", messageId: "+e.messageId)},e.prototype.cleanupCallKeeper=function(){this.activeCompanionDeviceCalls=[],this.states=void 0},e.prototype.getStates=function(){return this.states.set(o.ActiveCallDetails,JSON.stringify(this.activeCompanionDeviceCalls)),this.states},e}();n.TransportCallKeeper=i}},[2321]);
//# sourceMappingURL=https://statics.teams.cdn.office.net/hashedjs/lazy-ng1-mod-transport-agent-services.min.js-f4c98a6.map